Contributing to attachments
===========================

This guide is a practical, low‑friction workflow for contributing to the `attachments` library. It covers setup with `uv`, day‑to‑day development, tests, and docs with Quarto + quartodoc.

Contents
--------
- Quickstart (2 minutes)
- Prerequisites
- One‑time setup
- Daily development loop
- Running and editing docs
- Adding/removing dependencies
- Code style and conventions
- Tests and layout
- Branches, commits, and PRs
- Troubleshooting

Quickstart (2 minutes)
----------------------

```bash
# 1) Clone and enter the repo
git clone <your-fork-or-repo-url>.git attachments
cd attachments

# 2) Create the venv and install deps (uv)
#    (Installs dev deps, including optional processor libs used by tests.)
uv sync

# 3) Sanity checks
uv run ruff format .   # format
uv run ruff check .    # lint
uv run pytest -q       # tests

# 4) (Optional) Docs live preview
cd docs
quartodoc build --watch &
quarto preview
```

Prerequisites
-------------
- Python 3.12+
- `uv` for dependency and environment management
- Git
- Quarto CLI (for docs): `quarto check` should succeed

Tip: If you have multiple Python versions installed, use `uv python pin 3.12` (or your preferred minor) at the repo root to align collaborators.

One‑time setup
--------------
1. Fork the repo and clone your fork.
2. From the project root, install dependencies with uv:
   ```bash
   uv sync
   ```
   This creates `.venv/` and installs runtime + dev deps.
3. (Recommended) Install pre-commit and activate hooks once:
   ```bash
   uv tool install pre-commit --with pre-commit-uv
   pre-commit install
   ```
4. Verify everything works:
   ```bash
   uv run ruff check .
   uv run pytest -q
   ```

Daily development loop
----------------------
- Edit code under `src/attachments/`.
- Run the fast checks frequently:
  ```bash
  uv run ruff format .
  uv run ruff check .
  uv run pytest -q
  ```
- Run a single test file or test node:
  ```bash
  uv run pytest tests/test_import.py -q
  uv run pytest -k name_substring -q
  ```
- Run examples:
  ```bash
  uv run python examples/hello.py
  ```

Running and editing docs
------------------------
Docs are a Quarto website in `docs/`. API pages are auto‑generated by `quartodoc` from your docstrings at render time.

Install docs extras if you plan to build docs locally:
```bash
uv sync --extra docs
```

- Start a live preview + watch API pages:
  ```bash
  cd docs
  quartodoc build --watch   # rebuild API pages on docstring changes
  quarto preview            # live preview with auto‑reload
  ```
- One‑off render:
  ```bash
  cd docs && quartodoc build && quarto render
  ```
- Do not edit files in `docs/reference/` by hand — they are generated.

Publishing
----------
The repo includes a GitHub Actions workflow that renders and publishes the site to GitHub Pages on pushes to `main`. Make sure your PRs update docstrings and `*.qmd` pages as needed.

Adding/removing dependencies
----------------------------
Use `uv` to keep `pyproject.toml` in sync:

- Add a runtime dependency:
  ```bash
  uv add <package>
  ```
- Add a dev‑only dependency:
  ```bash
  uv add --dev <package>
  ```
  Note: Dev group already includes optional processor deps used in tests
  (e.g., `pandas`, `openpyxl`) so test suites don’t fail due to missing
  extras. If you want to keep a lighter dev env, remove them from
  `[dependency-groups].dev` and run tests that skip those paths.
- Docs extras live under `[project.optional-dependencies].docs`. You can also install docs deps directly via:
  ```bash
  pip install -e ".[docs]"
  ```
  or with uv extras:
  ```bash
  uv sync --extra docs
  ```
  Optional processor extras are grouped under `[project.optional-dependencies].excel`.
  To install them explicitly (outside of dev group):
  ```bash
  pip install -e ".[excel]"
  # or
  uv sync --extra excel
  ```

Code style and conventions
--------------------------
- Formatting and linting: `ruff format` and `ruff check` (already configured).
- Imports: managed by Ruff’s `I` (isort) rules.
- Type hints: encouraged where helpful, but not strictly enforced.
- Docstrings: prefer concise, actionable docstrings; Google or NumPy style both work. These power the API docs via quartodoc.

Tests and layout
----------------
- Place tests under `tests/` using `pytest`.
- Name tests like `test_*.py`, and keep them small and focused.
- When fixing bugs, add a test that would have failed before your change.

Branches, commits, and PRs
--------------------------
- Create feature branches from `main` (e.g., `feat/descriptive-name`, `fix/issue-123`).
- Keep PRs small and focused; include tests and doc updates where applicable.
- Run locally before pushing:
  ```bash
  uv run ruff format . && uv run ruff check . && uv run pytest -q
  ```
- Commit style: use clear, imperative messages. Conventional Commits are welcome but not required.

Troubleshooting
---------------
- Quarto not found: install the Quarto CLI and run `quarto check`.
- Python version mismatch: run `uv python pin 3.12` at the repo root; re‑run `uv sync` if needed.
- Missing deps when rendering docs locally: ensure docs extras are installed with `uv sync --extra docs` (or `pip install -e ".[docs]"`).
- uv TOML parse errors: this project does not use `[tool.uv.scripts]`; run tools directly via `uv run <tool>`.

Releasing (maintainers)
-----------------------
- Bump `__version__` in `src/attachments/__init__.py`.
- Build artifacts:
  ```bash
  uv build
  ```
- (Optional) Publish to PyPI using your preferred method.

CI notes
--------
- CI uses `astral-sh/setup-uv` and installs with `uv sync --locked` for reproducible builds. Run `uv lock --check` locally to ensure `uv.lock` matches `pyproject.toml` before pushing.

Thanks for contributing! Keeping the loop tight (format → lint → test → docs) and adding clear docstrings makes everyone more productive.
